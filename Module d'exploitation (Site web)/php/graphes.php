<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graphes</title>
    <link href="../css/principale.css" rel="stylesheet" type="text/css">
    <link rel="icon" href="../vid/logo.png" type="image/png">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>

<body>
    <header class="header">
        <nav class="navbar">
            <a href="donneesVol.php">Accueil</a>
            <a href="tableau.php">Données Utilisateurs</a>
            <a href="graphes.php">Graphes</a>
            <button id="bouton">Quitter</button>
        </nav>
    </header>

    <script>
        var bouton = document.getElementById('bouton'); //pour exit est revenir à la page du début 
        bouton.addEventListener('click', function () {
            var confirmation = confirm("Êtes-vous sûr de vouloir quitter ?");
            if (confirmation) {
                window.location.href = "../index.html";
            }
        });
    </script>

    <br><br><br><br><br><br>

    <div id="chart_div" style="margin: center; width: 60%; height: 200px;"></div>
    <br>
    <div id="chart_div2" style="margin: center; width: 60%; height: 200px;"></div>



    <?php
    if (isset($_COOKIE['code'])) {
        $code = $_COOKIE['code'];
        $placement = '../php/' . $code . '.txt';

        function init($code, $placement)
        {
            $valeurs = file_get_contents($placement);
            $valeurs_tableau = explode("\n", $valeurs);
            if (substr($code, 0, 1) == 'v') {
                $valeurs_tableau = array_slice($valeurs_tableau, 1, count($valeurs_tableau) - 2);
            } else {
                $valeurs_tableau = array_slice($valeurs_tableau, 0, count($valeurs_tableau) - 1);
            }
            return $valeurs_tableau;
        }

        function noms($valeurs_tableau)
        {
            $dictionnaire_noms = array();
            foreach ($valeurs_tableau as $val) {
                $tmp = explode("-", $val);
                $dictionnaire_noms[] = strtolower(explode(".", $tmp[0])[0]);
            }
            return $dictionnaire_noms;
        }

        $valeurs = init($code, $placement);
        $noms = noms($valeurs);

        $noms_json = json_encode($noms);


        $moyennes = array();
        for ($i = 0; $i < count($valeurs); $i++) {
            $donnees_charges = explode(".", explode("-", $valeurs[$i])[0]);
            $moyenne = 0;
            for ($m = 1; $m < count($donnees_charges); $m++) {
                $moyenne += $donnees_charges[$m];
            }
            $moyenne /= (count($donnees_charges) - 1);
            $moyennes[$i] = $moyenne;
        }
        $moyennes_json = json_encode($moyennes);
    }
    ?>

    <script type="text/javascript">
        google.charts.load('current', { 'packages': ['corechart'] });
        google.charts.setOnLoadCallback(drawChart);

        function drawChart() {

            var noms = <?php echo isset($noms_json) ? $noms_json : '[]'; ?>;
            var moyennes = <?php echo isset($moyennes_json) ? $moyennes_json : '[]'; ?>;


            var data = new google.visualization.DataTable();
            data.addColumn('string', 'Nom');
            data.addColumn('number', 'Moyenne');
            for (var i = 0; i < noms.length; i++) {
                data.addRow([noms[i], moyennes[i]]);
            }


            var options = {
                title: 'Graphe des moyennes des charges mentales par utilisateur (Vue personnelle)',
                legend: { position: 'none' },
                hAxis: {
                    title: 'Nom',
                    minValue: 0
                },
                vAxis: {
                    title: 'Moyenne',
                    minValue: 0
                }
            };


            var chart = new google.visualization.ColumnChart(document.getElementById('chart_div'));
            chart.draw(data, options);
        }
    </script>

    <?php
    $code = $_COOKIE['code'];
    $placement = '../php/' . $code . '.txt';
    $fichier = fopen($placement, 'r');

    if ($fichier) {
        $premiere_lettre = substr($code, 0, 1);
        if ($premiere_lettre == 'v') {
            fgets($fichier);
        }
        $valeurs = [];
        $noms = [];
        while (($ligne = fgets($fichier)) !== false) {
            $parties2 = explode('-', $ligne);
            $parties = explode('.', $parties2[0]);
            $nom = array_shift($parties);
            $noms[] = $nom;
            $valeurs[] = implode('.', $parties);
        }
        fclose($fichier);
    } else {
        echo "Impossible d'ouvrir le fichier.";
    }

    $nombre_valeurs = count(explode('.', $valeurs[0]));
    $nombre_valeurs_json = json_encode($nombre_valeurs);
    $noms_json = json_encode($noms);
    $valeurs_json = json_encode($valeurs);
    ?>
    <script type="text/javascript"> 
        google.charts.load('current', { 'packages': ['corechart'] });
        google.charts.setOnLoadCallback(drawChart);

        function drawChart() {
            //integrer les données php dans notre script JS pour pouvoir les utiliser
            var noms = <?php echo $noms_json; ?>; 
            var valeurs = <?php echo $valeurs_json; ?>;
            var nombre_valeurs = <?php echo $nombre_valeurs_json; ?>;

            var data = new google.visualization.DataTable();
            data.addColumn('number', 'X'); //la valeur de la mesur 
            for (var i = 0; i < noms.length; i++) {
                data.addColumn('number', noms[i]); //tous les noms dans le fichier les mettre en column
            }

            for (var j = 0; j < nombre_valeurs; j++) {
                var row = [j + 1];
                for (var i = 0; i < valeurs.length; i++) {
                    var val = valeurs[i].split('.')[j];
                    row.push(parseFloat(val)); //ajout des valeurs de la mesure 
                }
                data.addRow(row);
            }

            var options = {
                title: 'Évolution de la charge mentale des utilisateurs (Vue personnelle)',
                legend: { position: 'top' },
                hAxis: {
                    title: 'Mesure',
                    minValue: 1
                },
                vAxis: {
                    title: 'Valeur',
                    minValue: 0
                },
                pointSize: 0,
                series: {
                    1: { curveType: 'function' }
                }
            };

            var chart = new google.visualization.LineChart(document.getElementById('chart_div2'));
            chart.draw(data, options);
        }
    </script>
</body>

</html>