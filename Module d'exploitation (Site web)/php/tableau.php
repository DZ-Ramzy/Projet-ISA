<?php
$code = $_COOKIE['code'];
$placement = '../php/'.$code.'.txt';
$fichier = fopen($placement,'r');
 
function initialisation($code, $placement){
    $premiere_lettre = substr($code, 0, 1); 
    if($premiere_lettre == 'v'){
        $valeurs = file_get_contents($placement); //on récupére le contenu du fichier tout entier
        $valeurs_tableau = explode("\n", $valeurs); //on sépare les valeurs dans un tableau
        $valeurs_tableau = array_slice($valeurs_tableau, 1, count($valeurs_tableau)-2); //on ne récupère pas la première ligne, à voir si cette opération est utile car on fait un fgets... 
        //count($valeurs_tableau)-1 POUR LA DERNIERE LIGNE PROBABLEMENT VIDE
    }
    else{
        $valeurs = file_get_contents($placement); //on récupére le contenu du fichier tout entier
        $valeurs_tableau = explode("\n", $valeurs); //on sépare les valeurs dans un tableau
        $valeurs_tableau = array_slice($valeurs_tableau, 0, count($valeurs_tableau)-1); //
        //count($valeurs_tableau)-1 POUR LA DERNIERE LIGNE PROBABLEMENT VIDE
    }
    return $valeurs_tableau;
}
    
function noms($valeurs_tableau){
    $dictionnaire_noms = array(); //on défini un dictionnaire

    for($i = 0; $i<count($valeurs_tableau);$i+=1){
        $tmp = explode("-", $valeurs_tableau[$i]); //on mets dans un tableau temporaire les différentes données liées à chaque utilisateurs pour un utilisateur (à réexpliquer...)
        $dictionnaire_noms[$i] = strtolower(explode(".",$tmp[0])[0]); // on rajoute dans le dictionnaire tous les noms de l'expérimentation
    }
    return $dictionnaire_noms;
}

function tri($valeurs_tableau, $dictionnaire_noms){ //pas utile pour le moment
    $dictionnaire_charges = array();

    for($i = 0; $i<count($valeurs_tableau);$i+=1){ //ajouter les charges mentales individuelles + perçues au même endroit
        $dico_tmp = array(); //tableau temporaire
        $dico_tmp[0] = explode("-", $valeurs_tableau[$i])[0]; // on récupére que les charges mentales individuelles de l'utilisateur ainsi que son nom
        $indice = 1;
        for($e = 0;$e<count($valeurs_tableau);$e+=1){ //on récupère ses valeurs perçues par les autres
            if($e != $i){ //on ne récupère pas sa propre charge individuelle
                $tmp = explode("-",$valeurs_tableau[$e]);
                for($a = 0;$a<count($tmp);$a+=1){
                    if((strtolower(explode(".", $tmp[$a])[0])) == $dictionnaire_noms[$i]){ //si les noms sont les mêmes
                        //$dico_tmp[$e] = array_slice(explode(".", $tmp[$a]), 1); //on récupère sa charge mentale perçue par l'utilisateur $e
                        $dico_tmp[$indice] = $tmp[$a]; //on récupère la charge mentale perçue par l'utilisateur $e ainsi que son nom
                        $indice += 1;
                    }
                }
            }
        }
        $dictionnaire_charges[$i] = $dico_tmp;
    }
    return $dictionnaire_charges;
}


function creationTableauTriHTML($valeurs_tableau, $dictionnaire_noms){
    $body = '<table class = "important" id = "tab"><caption id = "legende">Moyenne des charges mentales des participants<br> en abcisse les utilisateurs qui notent la charge mentale<br>en ordonnée les utilisateurs qui sont notés</caption>'; //création du tableau html
    $body .= '<tr id = "tableheader"><th></th>'; //début de la première ligne
    
    for($i = 0;$i<count($dictionnaire_noms);$i+=1){ //on ajoute les noms dans la première ligne
        $body .= "<th>" . $dictionnaire_noms[$i] . "</th>";
    }
    $body .= "</tr>"; //fin de la première ligne 

    for($i = 0;$i<count($dictionnaire_noms);$i+=1){ //boucle pour peupler le tableau
        $body .= "<tr><td>" . $dictionnaire_noms[$i] . "</td>"; //début de la ligne
        
        for($e = 0;$e<count($dictionnaire_noms);$e+=1){

            $donnees_charges = explode("-",$valeurs_tableau[$e]);
            for($i_tmp=0;$i_tmp<count($donnees_charges);$i_tmp+=1){
                if( strtolower(explode(".", $donnees_charges[$i_tmp])[0]) == $dictionnaire_noms[$i] ){
                    $charges = array_slice(explode(".", $donnees_charges[$i_tmp]),1);
                    $moyenne = 0;
                    $compteur = 0;
                    for($c=0;$c<count($charges);$c+=1){
                        if((int)$charges[$c] != 0){
                            $moyenne += $charges[$c];
                            $compteur += 1;
                        }
                    }
                    $moyenne /= $compteur;
                    $body .= "<td>" . round($moyenne, 2) . "</td>"; //on ajoute la charge mentale (pour l'instant on ajoute aussi le nom)
                    //$body .= "<td>" . $donnees_charges[$i_tmp] . "</td>"; //on ajoute la charge mentale (pour l'instant on ajoiute aussi le nom)
                }
            }
        }
        $body .= "</tr>"; //fin de la ligne
    }
 
    $body .= '</table>';
    return $body;
}

function creationTableauBaseHTML($fichier, $code){
    $body = '<table  id="tab"><caption>Données brutes<br>chaque ligne correspond à un utilisateur (sa charge personnelle puis les charges qu\'il a donné aux autres)</caption>';
    $premiere_lettre = substr($code, 0, 1);
    if($premiere_lettre == 'v'){
        fgets($fichier); //on ignore la premiere ligne Et si c'est pas en mode vol ???
    }
 
    while (($ligne = fgets($fichier)) !== false) {
        $body .= '<tr>';
        $donnees = preg_split("/[.-]/", $ligne); // ??? 
 
        foreach ($donnees as $valeur) {
            $body .= '<td>' . htmlspecialchars($valeur) . '</td>';
        }
 
        $body.= '</tr>';
    }
 
    $body .= '</table>';
    return $body;
}

if ($fichier) {

    $valeurs = initialisation($code, $placement);
    $noms = noms($valeurs);
    $body = creationTableauTriHTML($valeurs, $noms);
    $body .= creationTableauBaseHTML($fichier, $code);

    fclose($fichier);

} else {
    $body = "Impossible d'ouvrir le fichier.";
}
 
$page = file_get_contents("../html/donnees.html");
if($page !== false)
{
    $page = str_replace("(Body)", $body ,$page);
    echo $page;
}